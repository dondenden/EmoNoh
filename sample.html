<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>感情推定データ収集</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #log { margin-top: 20px; height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
  #game-area { width: 100%; height: 300px; border: 1px solid #000; margin-top: 20px; position: relative; }
</style>
</head>
<body>

<h2>感情推定データ収集ページ</h2>
<p>ゲームエリアでマウスやキー操作をしてください。</p>
<div id="game-area"></div>

<div id="log"></div>

<script>
const logDiv = document.getElementById('log');
const gameArea = document.getElementById('game-area');

// データ格納用
let mouseData = [];
let keyData = [];

// 前回タイムスタンプ
let lastClickTime = null;
let lastKeyTime = null;
let lastMousePos = null;

// マウス移動イベント
gameArea.addEventListener('mousemove', e => {
    const time = performance.now();
    const pos = { x: e.offsetX, y: e.offsetY, t: time };
    if(lastMousePos) {
        const dx = pos.x - lastMousePos.x;
        const dy = pos.y - lastMousePos.y;
        const dt = (time - lastMousePos.t) / 1000; // 秒
        const speed = Math.sqrt(dx*dx + dy*dy) / dt; // px/s
        mouseData.push({ ...pos, speed });
    }
    lastMousePos = pos;
});

// クリックイベント
gameArea.addEventListener('click', e => {
    const time = performance.now();
    let interval = null;
    if(lastClickTime !== null) interval = time - lastClickTime;
    lastClickTime = time;
    mouseData.push({ type: 'click', x: e.offsetX, y: e.offsetY, interval });
    log(`Click at (${e.offsetX},${e.offsetY}) interval: ${interval ? interval.toFixed(0)+'ms' : '-'}`);
});

// キーボードイベント
document.addEventListener('keydown', e => {
    const time = performance.now();
    let interval = null;
    if(lastKeyTime !== null) interval = time - lastKeyTime;
    lastKeyTime = time;
    keyData.push({ key: e.key, t: time, interval });
    log(`Key: ${e.key} interval: ${interval ? interval.toFixed(0)+'ms' : '-'}`);
});

// ログ表示
function log(msg) {
    const p = document.createElement('div');
    p.textContent = msg;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
}

// 特徴量計算
function calculateFeatures() {
    // マウス速度平均
    const speeds = mouseData.filter(d => d.speed).map(d => d.speed);
    const avgMouseSpeed = speeds.length ? (speeds.reduce((a,b)=>a+b,0)/speeds.length).toFixed(2) : 0;

    // クリック間隔平均
    const clickIntervals = mouseData.filter(d => d.interval).map(d => d.interval);
    const avgClickInterval = clickIntervals.length ? (clickIntervals.reduce((a,b)=>a+b,0)/clickIntervals.length).toFixed(0) : 0;

    // キー間隔平均
    const keyIntervals = keyData.filter(d => d.interval).map(d => d.interval);
    const avgKeyInterval = keyIntervals.length ? (keyIntervals.reduce((a,b)=>a+b,0)/keyIntervals.length).toFixed(0) : 0;

    log(`---特徴量---`);
    log(`平均マウス速度: ${avgMouseSpeed} px/s`);
    log(`平均クリック間隔: ${avgClickInterval} ms`);
    log(`平均キー間隔: ${avgKeyInterval} ms`);

    // LocalStorageに保存
    const dataToSave = {
        timestamp: new Date().toISOString(),
        avgMouseSpeed,
        avgClickInterval,
        avgKeyInterval
    };
    let savedData = JSON.parse(localStorage.getItem('emotionData') || '[]');
    savedData.push(dataToSave);
    localStorage.setItem('emotionData', JSON.stringify(savedData));
    log(`特徴量を保存しました。`);
}

// 10秒ごとに特徴量計算
setInterval(calculateFeatures, 10000);
</script>

</body>
</html>