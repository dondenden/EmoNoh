<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>EmoNoh Keystroke Emotion Estimation Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 20px;
      background-color: #f0f4f9;
    }
    h1 {
      margin-bottom: 10px;
    }
    #gameArea {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    #target {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #inputBox {
      font-size: 24px;
      width: 100%;
      padding: 5px;
    }
    button {
      margin-top: 5px;
      margin-right: 5px;
      padding: 8px 12px;
      font-size: 16px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>🎮 EmoNoh — Keystroke 感情推定デモ（3クラス）</h1>

  <div id="gameArea">
    <div id="target">--- START ---</div>
    <input type="text" id="inputBox" placeholder="ここに入力" disabled>

    <br>
    <button id="startGame">ゲーム開始</button>
    <select id="label">
      <option value="0">集中</option>
      <option value="1">困惑</option>
      <option value="2">退屈</option>
    </select>
    <button id="collect">データ追加</button>
    <button id="train">モデル学習</button>
    <button id="predict">感情推定</button>

    <div id="status">状態: 待機中</div>
  </div>

  <script>
    const classNames = ["集中", "困惑", "退屈"];
    const input = document.getElementById('inputBox');
    const target = document.getElementById('target');
    const status = document.getElementById('status');

    let model;
    const examples = [];
    const labels = [];

    let keystrokeIntervals = [];
    let lastKeyTime = null;
    let errorCount = 0;
    let startTime;
    let word;
    let finished = false;

    // ランダムな単語生成
    function randomWord(length=6){
      const chars = 'abcdefghijklmnopqrstuvwxyz';
      return Array.from({length},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
    }

    // ゲーム開始
    document.getElementById('startGame').addEventListener('click', ()=>{
      word = randomWord(5 + Math.floor(Math.random()*4));
      target.textContent = word;
      input.value = '';
      input.disabled = false;
      input.focus();
      keystrokeIntervals = [];
      lastKeyTime = null;
      errorCount = 0;
      finished = false;
      startTime = Date.now();
      status.textContent = "状態: プレイ中...";
    });

    // キー押下間隔の記録
    input.addEventListener('keydown', e=>{
      if (finished) return;
      const now = Date.now();
      if (lastKeyTime) keystrokeIntervals.push(now - lastKeyTime);
      lastKeyTime = now;
    });

    // 入力中にミスカウント
    input.addEventListener('input', ()=>{
      const val = input.value;
      if (!word.startsWith(val)) errorCount++;
      if (val === word) {
        finished = true;
        const duration = Date.now() - startTime;
        input.disabled = true;
        status.textContent = `✅ 完了！ 所要時間: ${duration}ms | エラー数: ${errorCount}`;
      }
    });

    // 特徴量抽出
    function getFeatures(){
      const avgInterval = keystrokeIntervals.length
        ? keystrokeIntervals.reduce((a,b)=>a+b,0)/keystrokeIntervals.length
        : 0;
      const speed = word.length / ((Date.now()-startTime)/1000);
      return [avgInterval || 0, errorCount, speed];
    }

    // モデル構築
    function createModel(){
      const m = tf.sequential();
      m.add(tf.layers.dense({inputShape:[3], units:16, activation:'relu'}));
      m.add(tf.layers.dense({units:8, activation:'relu'}));
      m.add(tf.layers.dense({units:3, activation:'softmax'}));
      m.compile({optimizer: tf.train.adam(0.01), loss:'categoricalCrossentropy', metrics:['accuracy']});
      return m;
    }

    // データ追加
    document.getElementById('collect').addEventListener('click', ()=>{
      const feat = getFeatures();
      if (feat[2] === 0) return alert("まずゲームを1回プレイしてください");
      examples.push(feat);
      labels.push(parseInt(document.getElementById('label').value));
      status.textContent = `📊 データ数: ${examples.length}`;
    });

    // 学習
    document.getElementById('train').addEventListener('click', async ()=>{
      if (examples.length < 5) return alert("データが少なすぎます（最低5件以上）");
      const xs = tf.tensor2d(examples);
      const ys = tf.oneHot(tf.tensor1d(labels,'int32'), 3);
      model = createModel();
      await model.fit(xs, ys, {epochs: 50, shuffle:true});
      xs.dispose(); ys.dispose();
      status.textContent = "🧠 モデル学習完了";
    });

    // 推定
    document.getElementById('predict').addEventListener('click', async ()=>{
      if (!model) return alert("モデルを先に学習してください");
      const feat = getFeatures();
      const t = tf.tensor2d([feat]);
      const pred = model.predict(t);
      const arr = await pred.data();
      const idx = arr.indexOf(Math.max(...arr));
      status.textContent = `🪞 推定感情: ${classNames[idx]} (確信度 ${(arr[idx]*100).toFixed(1)}%)`;
      t.dispose(); pred.dispose();
    });
  </script>
</body>
</html>