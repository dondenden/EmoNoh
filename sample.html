<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>EmoNoh Keystroke Emotion Estimation Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 20px;
      background-color: #f0f4f9;
    }
    h1 {
      margin-bottom: 10px;
    }
    #gameArea {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    #target {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #inputBox {
      font-size: 24px;
      width: 100%;
      padding: 5px;
    }
    button {
      margin-top: 5px;
      margin-right: 5px;
      padding: 8px 12px;
      font-size: 16px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ® EmoNoh â€” Keystroke æ„Ÿæƒ…æ¨å®šãƒ‡ãƒ¢ï¼ˆ3ã‚¯ãƒ©ã‚¹ï¼‰</h1>

  <div id="gameArea">
    <div id="target">--- START ---</div>
    <input type="text" id="inputBox" placeholder="ã“ã“ã«å…¥åŠ›" disabled>

    <br>
    <button id="startGame">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    <select id="label">
      <option value="0">é›†ä¸­</option>
      <option value="1">å›°æƒ‘</option>
      <option value="2">é€€å±ˆ</option>
    </select>
    <button id="collect">ãƒ‡ãƒ¼ã‚¿è¿½åŠ </button>
    <button id="train">ãƒ¢ãƒ‡ãƒ«å­¦ç¿’</button>
    <button id="predict">æ„Ÿæƒ…æ¨å®š</button>

    <div id="status">çŠ¶æ…‹: å¾…æ©Ÿä¸­</div>
  </div>

  <script>
    const classNames = ["é›†ä¸­", "å›°æƒ‘", "é€€å±ˆ"];
    const input = document.getElementById('inputBox');
    const target = document.getElementById('target');
    const status = document.getElementById('status');

    let model;
    const examples = [];
    const labels = [];

    let keystrokeIntervals = [];
    let lastKeyTime = null;
    let errorCount = 0;
    let startTime;
    let word;
    let finished = false;

    // ãƒ©ãƒ³ãƒ€ãƒ ãªå˜èªç”Ÿæˆ
    function randomWord(length=6){
      const chars = 'abcdefghijklmnopqrstuvwxyz';
      return Array.from({length},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    document.getElementById('startGame').addEventListener('click', ()=>{
      word = randomWord(5 + Math.floor(Math.random()*4));
      target.textContent = word;
      input.value = '';
      input.disabled = false;
      input.focus();
      keystrokeIntervals = [];
      lastKeyTime = null;
      errorCount = 0;
      finished = false;
      startTime = Date.now();
      status.textContent = "çŠ¶æ…‹: ãƒ—ãƒ¬ã‚¤ä¸­...";
    });

    // ã‚­ãƒ¼æŠ¼ä¸‹é–“éš”ã®è¨˜éŒ²
    input.addEventListener('keydown', e=>{
      if (finished) return;
      const now = Date.now();
      if (lastKeyTime) keystrokeIntervals.push(now - lastKeyTime);
      lastKeyTime = now;
    });

    // å…¥åŠ›ä¸­ã«ãƒŸã‚¹ã‚«ã‚¦ãƒ³ãƒˆ
    input.addEventListener('input', ()=>{
      const val = input.value;
      if (!word.startsWith(val)) errorCount++;
      if (val === word) {
        finished = true;
        const duration = Date.now() - startTime;
        input.disabled = true;
        status.textContent = `âœ… å®Œäº†ï¼ æ‰€è¦æ™‚é–“: ${duration}ms | ã‚¨ãƒ©ãƒ¼æ•°: ${errorCount}`;
      }
    });

    // ç‰¹å¾´é‡æŠ½å‡º
    function getFeatures(){
      const avgInterval = keystrokeIntervals.length
        ? keystrokeIntervals.reduce((a,b)=>a+b,0)/keystrokeIntervals.length
        : 0;
      const speed = word.length / ((Date.now()-startTime)/1000);
      return [avgInterval || 0, errorCount, speed];
    }

    // ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰
    function createModel(){
      const m = tf.sequential();
      m.add(tf.layers.dense({inputShape:[3], units:16, activation:'relu'}));
      m.add(tf.layers.dense({units:8, activation:'relu'}));
      m.add(tf.layers.dense({units:3, activation:'softmax'}));
      m.compile({optimizer: tf.train.adam(0.01), loss:'categoricalCrossentropy', metrics:['accuracy']});
      return m;
    }

    // ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
    document.getElementById('collect').addEventListener('click', ()=>{
      const feat = getFeatures();
      if (feat[2] === 0) return alert("ã¾ãšã‚²ãƒ¼ãƒ ã‚’1å›ãƒ—ãƒ¬ã‚¤ã—ã¦ãã ã•ã„");
      examples.push(feat);
      labels.push(parseInt(document.getElementById('label').value));
      status.textContent = `ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ•°: ${examples.length}`;
    });

    // å­¦ç¿’
    document.getElementById('train').addEventListener('click', async ()=>{
      if (examples.length < 5) return alert("ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã¾ã™ï¼ˆæœ€ä½5ä»¶ä»¥ä¸Šï¼‰");
      const xs = tf.tensor2d(examples);
      const ys = tf.oneHot(tf.tensor1d(labels,'int32'), 3);
      model = createModel();
      await model.fit(xs, ys, {epochs: 50, shuffle:true});
      xs.dispose(); ys.dispose();
      status.textContent = "ğŸ§  ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å®Œäº†";
    });

    // æ¨å®š
    document.getElementById('predict').addEventListener('click', async ()=>{
      if (!model) return alert("ãƒ¢ãƒ‡ãƒ«ã‚’å…ˆã«å­¦ç¿’ã—ã¦ãã ã•ã„");
      const feat = getFeatures();
      const t = tf.tensor2d([feat]);
      const pred = model.predict(t);
      const arr = await pred.data();
      const idx = arr.indexOf(Math.max(...arr));
      status.textContent = `ğŸª æ¨å®šæ„Ÿæƒ…: ${classNames[idx]} (ç¢ºä¿¡åº¦ ${(arr[idx]*100).toFixed(1)}%)`;
      t.dispose(); pred.dispose();
    });
  </script>
</body>
</html>