<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ„Ÿæƒ…æ¨å®šãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆæ”¹å–„ç‰ˆï¼‰</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #log { margin-top: 10px; height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; }
  #game-area { width: 600px; height: 400px; border: 1px solid #000; position: relative; margin-top: 20px; }
  #target { width: 50px; height: 50px; background: red; border-radius: 50%; position: absolute; cursor: pointer; }
  #avatar { width:100px; height:100px; margin-top:20px; font-size:50px; text-align:center; }
</style>
</head>
<body>

<h2>æ„Ÿæƒ…æ¨å®šãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆæ”¹å–„ç‰ˆï¼‰</h2>
<p>èµ¤ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚æ“ä½œçŠ¶æ³ã«å¿œã˜ã¦ã‚¢ãƒã‚¿ãƒ¼ãŒæ„Ÿæƒ…ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>

<div id="game-area">
  <div id="target"></div>
</div>
<div id="avatar">ğŸ˜</div>
<div id="log"></div>

<script>
const logDiv = document.getElementById('log');
const gameArea = document.getElementById('game-area');
const target = document.getElementById('target');
const avatar = document.getElementById('avatar');

// ãƒ‡ãƒ¼ã‚¿æ ¼ç´
let mouseData = [];
let keyData = [];
let targetClicks = [];

// ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š
let targetSpeed = 2;
let targetDir = {x:1, y:1};

// ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç§»å‹•
function moveTarget() {
    let rect = gameArea.getBoundingClientRect();
    let pos = target.getBoundingClientRect();
    let newX = pos.left - rect.left + targetDir.x*targetSpeed;
    let newY = pos.top - rect.top + targetDir.y*targetSpeed;
    if(newX<0||newX>rect.width-50) targetDir.x*=-1;
    if(newY<0||newY>rect.height-50) targetDir.y*=-1;
    target.style.left=Math.max(0, Math.min(rect.width-50,newX))+'px';
    target.style.top=Math.max(0, Math.min(rect.height-50,newY))+'px';
    requestAnimationFrame(moveTarget);
}
moveTarget();

// ãƒ­ã‚°è¡¨ç¤º
function log(msg){
    const p=document.createElement('div');
    p.textContent=msg;
    logDiv.appendChild(p);
    logDiv.scrollTop=logDiv.scrollHeight;
}

// ãƒã‚¦ã‚¹ç§»å‹•
let lastMousePos=null;
gameArea.addEventListener('mousemove', e=>{
    const t=performance.now();
    const pos={x:e.offsetX, y:e.offsetY, t};
    if(lastMousePos){
        const dx=pos.x-lastMousePos.x;
        const dy=pos.y-lastMousePos.y;
        const dt=(t-lastMousePos.t)/1000;
        const speed=Math.sqrt(dx*dx+dy*dy)/dt;
        mouseData.push({...pos, speed});
    }
    lastMousePos=pos;
});

// ã‚¯ãƒªãƒƒã‚¯
target.addEventListener('click', e=>{
    const t=performance.now();
    mouseData.push({type:'click', x:e.offsetX, y:e.offsetY, t});
    targetClicks.push({t, success:true});
    log(`ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯: ${e.offsetX},${e.offsetY}`);
});

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
let lastKeyTime=null;
document.addEventListener('keydown', e=>{
    const t=performance.now();
    let interval=lastKeyTime? t-lastKeyTime:null;
    lastKeyTime=t;
    keyData.push({key:e.key, t, interval});
});

// æ”¹å–„ç‰ˆï¼šè¤‡åˆã‚¹ã‚³ã‚¢ã«ã‚ˆã‚‹æ„Ÿæƒ…æ¨å®š
function estimateEmotion(){
    const now=performance.now();
    let score = 0; // 0=é›†ä¸­,1=é€€å±ˆ,2ä»¥ä¸Š=å›°æƒ‘

    // ãƒã‚¦ã‚¹é€Ÿåº¦
    const speeds=mouseData.filter(d=>d.speed).map(d=>d.speed);
    const avgSpeed=speeds.length?speeds.reduce((a,b)=>a+b,0)/speeds.length:0;
    if(avgSpeed<20 || avgSpeed>300) score +=1;

    // ã‚­ãƒ¼å…¥åŠ›å®‰å®šæ€§
    const keyIntervals=keyData.filter(d=>d.interval).map(d=>d.interval);
    const keyStd=keyIntervals.length? Math.sqrt(keyIntervals.map(x=>Math.pow(x-(keyIntervals.reduce((a,b)=>a+b,0)/keyIntervals.length),2)).reduce((a,b)=>a+b,0)/keyIntervals.length) :0;
    if(keyStd>500) score +=1;

    // ã‚¯ãƒªãƒƒã‚¯ç²¾åº¦
    const successRate=targetClicks.length? targetClicks.filter(c=>c.success).length/targetClicks.length :1;
    if(successRate<0.5) score +=1;

    // æ”¾ç½®åˆ¤å®š
    const lastActionTime=Math.max(
        mouseData.length? mouseData[mouseData.length-1].t:0,
        keyData.length? keyData[keyData.length-1].t:0,
        targetClicks.length? targetClicks[targetClicks.length-1].t:0
    );
    if(now-lastActionTime>8000) score = 1; // é€€å±ˆ

    if(score===0) return 'é›†ä¸­';
    else if(score===1) return 'é€€å±ˆ';
    else return 'å›°æƒ‘';
}

// ã‚¢ãƒã‚¿ãƒ¼æ›´æ–°
function updateAvatar(){
    const emotion=estimateEmotion();
    if(emotion==='é›†ä¸­') avatar.textContent='ğŸ˜ƒ';
    else if(emotion==='å›°æƒ‘') avatar.textContent='ğŸ˜–';
    else if(emotion==='é€€å±ˆ') avatar.textContent='ğŸ˜´';
}

// ãƒ‡ãƒ¼ã‚¿ä¿å­˜
function saveData(){
    const now=new Date().toISOString();
    const emotion=estimateEmotion();
    const speeds=mouseData.filter(d=>d.speed).map(d=>d.speed);
    const avgSpeed=speeds.length?speeds.reduce((a,b)=>a+b,0)/speeds.length:0;
    const keyIntervals=keyData.filter(d=>d.interval).map(d=>d.interval);
    const avgKeyInterval=keyIntervals.length? keyIntervals.reduce((a,b)=>a+b,0)/keyIntervals.length:0;

    const data={timestamp:now, avgMouseSpeed:avgSpeed, clickCount:targetClicks.length, avgKeyInterval, emotion};
    let stored=JSON.parse(localStorage.getItem('emotionProtoImproved')||'[]');
    stored.push(data);
    localStorage.setItem('emotionProtoImproved',JSON.stringify(stored));
    log(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜: ${JSON.stringify(data)}`);
}

// å®šæœŸæ›´æ–°
setInterval(()=>{updateAvatar(); saveData();},5000);

</script>
</body>
</html>