<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Mouse Emotion Data Collection Game</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #gameArea {
      width: 800px; height: 500px; border: 2px solid #333;
      position: relative; margin-bottom: 20px;
      background: #f9f9f9;
      overflow: hidden;
    }
    .target {
      border-radius: 50%;
      background: red;
      position: absolute;
      cursor: pointer;
      transition: left 0.2s linear, top 0.2s linear;
    }
    #status { font-weight: bold; margin-bottom: 10px; }
    #log { white-space: pre-wrap; font-size: 12px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    #survey { display: none; margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    #exportBtn { margin-top: 10px; }
    .flash {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      opacity: 0.4;
      z-index: 10;
    }
    .flash.green { background: rgba(0,255,0,0.3); }
    .flash.red { background: rgba(255,0,0,0.3); }
    #conditionPanel {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #aaa;
      background: #f0f0f0;
    }
  </style>
</head>
<body>

<h2>Mouse Emotion Data Collection Game</h2>

<div id="conditionPanel">
  <strong>å®Ÿé¨“æ¡ä»¶é¸æŠï¼š</strong>
  <label><input type="radio" name="condition" value="low" checked /> Lowï¼ˆä½é›£åº¦ï¼‰</label>
  <label><input type="radio" name="condition" value="high" /> Highï¼ˆé«˜é›£åº¦ï¼‰</label>
</div>

<p id="status">ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
<button id="startBtn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>

<div id="gameArea"></div>

<div id="survey">
  <h3>è‡ªå·±ç”³å‘Š</h3>
  <label>Valenceï¼ˆ1=ã¨ã¦ã‚‚ä¸å¿«, 7=ã¨ã¦ã‚‚å¿«ï¼‰:
    <input type="number" id="valenceInput" min="1" max="7" />
  </label><br><br>
  <label>Attentivenessï¼ˆ1=å…¨ãé›†ä¸­ã—ã¦ã„ãªã„, 7=éå¸¸ã«é›†ä¸­ï¼‰:
    <input type="number" id="attentivenessInput" min="1" max="7" />
  </label><br><br>
  <button id="submitSurveyBtn">é€ä¿¡</button>
</div>

<button id="exportBtn">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
<pre id="log"></pre>

<script>
// =======================
// è¨­å®š
// =======================
const GAME_DURATION_MS = 30000;
const WINDOW_LENGTH_MS = 5000;
const SAMPLING_INTERVAL = 10;
const EMA_ALPHA = 0.05;
const TARGET_SCORE_GOAL = 20;

// =======================
// çŠ¶æ…‹å¤‰æ•°
// =======================
let mouseLogs = [];
let lastSampleTime = 0;
let lastWindowEnd = performance.now();
let currentSessionId = null;
let windowFeatureBuffer = [];
let currentCondition = "low";

// å€‹äººãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³
let personalBaseline = { mean: null, sampleCount: 0 };

// å…¨ä½“çµ±è¨ˆ
let globalStats = { globalMean: null, globalStd: null, sampleCount: 0 };

// ã‚²ãƒ¼ãƒ çŠ¶æ…‹
const gameArea = document.getElementById('gameArea');
const statusText = document.getElementById('status');
let gameTimer = null;
let difficultyTimer = null;
let target = null;
let score = 0;
let difficultyLevel = 1;
let gameStartTime = 0;

// =======================
// ãƒã‚¦ã‚¹ãƒ­ã‚°åé›†
// =======================
function logMouseEvent(e, type) {
  const now = performance.now();
  if (type === 'move' && now - lastSampleTime < SAMPLING_INTERVAL) return;
  lastSampleTime = now;
  mouseLogs.push({ mouse_x: e.clientX, mouse_y: e.clientY, timestamp: now, event_type: type });
}
document.addEventListener('mousemove', e => logMouseEvent(e, 'move'));
document.addEventListener('mousedown', e => logMouseEvent(e, 'click'));
document.addEventListener('mouseup',   e => logMouseEvent(e, 'release'));

// =======================
// ç‰¹å¾´é‡æŠ½å‡º
// =======================
function extractFeatures(logs) {
  if (!logs || logs.length < 2) return null;
  let trajectoryLength = 0;
  let deviations = [];
  let velocities = [];
  let pauses = 0;
  let directionChanges = 0;
  let curvatures = [];

  for (let i = 1; i < logs.length; i++) {
    const p0 = logs[i - 1];
    const p1 = logs[i];
    const dx = p1.mouse_x - p0.mouse_x;
    const dy = p1.mouse_y - p0.mouse_y;
    const dt = (p1.timestamp - p0.timestamp) / 1000;
    const dist = Math.hypot(dx, dy);
    trajectoryLength += dist;
    if (dt > 0) velocities.push(dist / dt);
    if (dt > 0.3) pauses++;
    deviations.push(dist);
    if (i >= 2) {
      const p_1 = logs[i - 2];
      const v1x = p0.mouse_x - p_1.mouse_x;
      const v1y = p0.mouse_y - p_1.mouse_y;
      const v2x = p1.mouse_x - p0.mouse_x;
      const v2y = p1.mouse_y - p0.mouse_y;
      const dot = v1x * v2x + v1y * v2y;
      const mag1 = Math.hypot(v1x, v1y);
      const mag2 = Math.hypot(v2x, v2y);
      if (mag1 > 0 && mag2 > 0) {
        const angle = Math.acos(Math.min(Math.max(dot / (mag1 * mag2), -1), 1));
        if (angle > Math.PI / 4) directionChanges++;
        curvatures.push(angle);
      }
    }
  }

  const meanDeviation = deviations.reduce((a, b) => a + b, 0) / deviations.length;
  const maxDeviation = Math.max(...deviations);
  const meanVelocity = velocities.reduce((a, b) => a + b, 0) / velocities.length;
  const maxVelocity = Math.max(...velocities);
  const velocityStd = Math.sqrt(
    velocities.reduce((sum, v) => sum + Math.pow(v - meanVelocity, 2), 0) / velocities.length
  );
  const pauseRatio = pauses / logs.length;
  const curvatureMean = curvatures.length ? curvatures.reduce((a, b) => a + b, 0) / curvatures.length : 0;
  const curvatureStd = curvatures.length
    ? Math.sqrt(curvatures.reduce((s, c) => s + Math.pow(c - curvatureMean, 2), 0) / curvatures.length)
    : 0;

  return {
    trajectory_length: trajectoryLength,
    mean_deviation: meanDeviation,
    max_deviation: maxDeviation,
    direction_change_count: directionChanges,
    curvature_mean: curvatureMean,
    curvature_std: curvatureStd,
    mean_velocity: meanVelocity,
    max_velocity: maxVelocity,
    velocity_std: velocityStd,
    pause_ratio: pauseRatio
  };
}

// =======================
// å€‹äººãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ + å·®åˆ†
// =======================
function updateBaselineAndComputeDelta(features) {
  if (!features) return null;
  if (!personalBaseline.mean) {
    personalBaseline.mean = { ...features };
    personalBaseline.sampleCount = 1;
  } else {
    for (const key in features) {
      personalBaseline.mean[key] = EMA_ALPHA * features[key] + (1 - EMA_ALPHA) * personalBaseline.mean[key];
    }
    personalBaseline.sampleCount++;
  }
  const delta = {};
  for (const key in features) delta[key] = features[key] - personalBaseline.mean[key];
  return delta;
}

// =======================
// å…¨ä½“çµ±è¨ˆ
// =======================
function updateGlobalStats(features) {
  if (!features) return;
  if (!globalStats.globalMean) {
    globalStats.globalMean = { ...features };
    globalStats.globalStd = {};
    for (const key in features) globalStats.globalStd[key] = 0;
    globalStats.sampleCount = 1;
  } else {
    globalStats.sampleCount++;
    for (const key in features) {
      const prevMean = globalStats.globalMean[key];
      const curr = features[key];
      const newMean = prevMean + (curr - prevMean) / globalStats.sampleCount;
      const prevVar = globalStats.globalStd[key] ** 2;
      const newVar = prevVar + (curr - prevMean) * (curr - newMean);
      globalStats.globalMean[key] = newMean;
      globalStats.globalStd[key] = Math.sqrt(newVar);
    }
  }
}

// =======================
// ãƒ¢ãƒ‡ãƒ«å…¥åŠ›æ§‹ç¯‰
// =======================
function buildModelInput(features, delta) {
  const input = [];
  for (const key in features) {
    const mean = globalStats.globalMean?.[key] ?? 0;
    const std = globalStats.globalStd?.[key] ?? 1;
    const z = std > 0 ? (features[key] - mean) / std : 0;
    input.push(z);
  }
  for (const key in delta) input.push(delta[key]);
  return input;
}

// =======================
// ãƒ€ãƒŸãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼ˆå¾Œã§å·®ã—æ›¿ãˆï¼‰
// =======================
function dummyModelPredict(input) {
  const positive = Math.min(1, Math.max(0, 0.5 + input[0] * 0.1));
  const attentive = Math.min(1, Math.max(0, 0.5 + input[1] * 0.1));
  return [positive, attentive];
}

function runInference(modelInput) {
  const output = dummyModelPredict(modelInput);
  return {
    positive_affect_score: output[0],
    attentiveness_score: output[1],
    confidence: 1.0,
    timestamp: Date.now()
  };
}

// =======================
// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å‡¦ç†ãƒ«ãƒ¼ãƒ—
// =======================
setInterval(() => {
  const now = performance.now();
  if (now - lastWindowEnd >= WINDOW_LENGTH_MS) {
    const windowLogs = mouseLogs.filter(log => log.timestamp >= lastWindowEnd && log.timestamp < now);
    lastWindowEnd = now;

    const features = extractFeatures(windowLogs);
    if (!features) return;

    updateGlobalStats(features);
    const delta = updateBaselineAndComputeDelta(features);
    const modelInput = buildModelInput(features, delta);
    const prediction = runInference(modelInput);

    windowFeatureBuffer.push({
      timestamp: Date.now(),
      session_id: currentSessionId,
      condition: currentCondition,
      difficulty_level: difficultyLevel,
      features,
      delta,
      modelInput,
      prediction
    });

    document.getElementById('log').textContent +=
      `\n[Window] ${JSON.stringify(prediction)}`;
  }
}, 500);

// =======================
// è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
// =======================
function flashScreen(color) {
  const flash = document.createElement('div');
  flash.className = `flash ${color}`;
  gameArea.appendChild(flash);
  setTimeout(() => flash.remove(), 120);
}

// =======================
// é›£æ˜“åº¦åˆ¶å¾¡
// =======================
function updateDifficulty(elapsedMs) {
  if (currentCondition === "low") {
    difficultyLevel = 1;
  } else {
    if (elapsedMs > 20000) difficultyLevel = 3;
    else if (elapsedMs > 10000) difficultyLevel = 2;
    else difficultyLevel = 1;
  }
}

// =======================
// ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
// =======================
function createTarget() {
  if (target) target.remove();
  target = document.createElement('div');
  target.className = 'target';

  let size = 40;
  if (difficultyLevel === 2) size = 30;
  if (difficultyLevel === 3) size = 20;

  target.style.width = size + 'px';
  target.style.height = size + 'px';

  const x = Math.random() * (gameArea.clientWidth - size);
  const y = Math.random() * (gameArea.clientHeight - size);
  target.style.left = x + 'px';
  target.style.top = y + 'px';

  target.addEventListener('click', (e) => {
    e.stopPropagation();
    score++;
    flashScreen('green');
    createTarget();
  });

  gameArea.appendChild(target);

  if (difficultyLevel === 3) {
    const moveInterval = setInterval(() => {
      if (!target) return clearInterval(moveInterval);
      const nx = Math.random() * (gameArea.clientWidth - size);
      const ny = Math.random() * (gameArea.clientHeight - size);
      target.style.left = nx + 'px';
      target.style.top = ny + 'px';
    }, 900);
  }
}

// ç©ºã‚¯ãƒªãƒƒã‚¯æ¤œå‡º
gameArea.addEventListener('click', (e) => {
  if (e.target !== target) {
    flashScreen('red');
  }
});

function startGame() {
  score = 0;
  mouseLogs = [];
  windowFeatureBuffer = [];
  currentSessionId = `session_${currentCondition}_${Date.now()}`;
  lastWindowEnd = performance.now();
  statusText.textContent = `ã‚²ãƒ¼ãƒ ä¸­...ï¼ˆæ¡ä»¶: ${currentCondition.toUpperCase()}ï¼‰`;
  document.getElementById('survey').style.display = 'none';

  // æ¡ä»¶å–å¾—
  const radios = document.getElementsByName('condition');
  for (const r of radios) {
    if (r.checked) currentCondition = r.value;
  }

  gameStartTime = performance.now();
  difficultyLevel = 1;
  createTarget();

  difficultyTimer = setInterval(() => {
    const elapsed = performance.now() - gameStartTime;
    updateDifficulty(elapsed);
  }, 1000);

  gameTimer = setTimeout(endGame, GAME_DURATION_MS);
}

function endGame() {
  clearTimeout(gameTimer);
  clearInterval(difficultyTimer);
  if (target) target.remove();

  const success = score >= TARGET_SCORE_GOAL;
  statusText.textContent = success
    ? `ğŸ‰ ç›®æ¨™é”æˆï¼ã‚¹ã‚³ã‚¢: ${score}`
    : `âŒ ç›®æ¨™æœªé”æˆâ€¦ ã‚¹ã‚³ã‚¢: ${score}`;

  document.getElementById('survey').style.display = 'block';
}

// =======================
// è‡ªå·±ç”³å‘Šå‡¦ç†
// =======================
document.getElementById('submitSurveyBtn').addEventListener('click', () => {
  const valence = Number(document.getElementById('valenceInput').value);
  const attentiveness = Number(document.getElementById('attentivenessInput').value);
  if (!valence || !attentiveness) {
    alert('Valenceã¨Attentivenessã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  const record = {
    subject_id: 'S01',
    session_id: currentSessionId,
    condition: currentCondition,
    score,
    label_valence: valence,
    label_attentiveness: attentiveness,
    windows: windowFeatureBuffer
  };

  const allData = JSON.parse(localStorage.getItem('emotionData') || '[]');
  allData.push(record);
  localStorage.setItem('emotionData', JSON.stringify(allData));

  document.getElementById('log').textContent += '\n[Saved] ' + JSON.stringify(record, null, 2);
  alert('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
});

// =======================
// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
// =======================
document.getElementById('exportBtn').addEventListener('click', () => {
  const allData = JSON.parse(localStorage.getItem('emotionData') || '[]');
  if (allData.length === 0) {
    alert('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
    return;
  }

  let csv = 'subject_id,session_id,condition,score,window_timestamp,label_valence,label_attentiveness,feature_key,feature_value,delta_value\n';

  allData.forEach(session => {
    session.windows.forEach(win => {
      for (const key in win.features) {
        csv += `${session.subject_id},${session.session_id},${session.condition},${session.score},${win.timestamp},${session.label_valence},${session.label_attentiveness},${key},${win.features[key]},${win.delta[key]}\n`;
      }
    });
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'emotion_dataset.csv';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// =======================
// ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰
// =======================
document.getElementById('startBtn').addEventListener('click', startGame);
</script>

</body>
</html>