<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Mouse Logger + Segmentation</title>
</head>
<body>
  <h2>Mouse Logger + Segmentation</h2>
  <p>マウスを動かしたりクリックしてください。</p>

  <script>
    const mouseLogs = [];
    const windows = [];

    let lastLogTime = 0;
    const TARGET_HZ = 100;
    const MIN_INTERVAL = 1000 / TARGET_HZ;

    const WINDOW_LENGTH_MS = 5000; // 5秒ウィンドウ

    function logMouseEvent(e, type) {
      const now = performance.now();
      if (type === "move" && now - lastLogTime < MIN_INTERVAL) return;

      lastLogTime = now;

      mouseLogs.push({
        mouse_x: e.clientX,
        mouse_y: e.clientY,
        timestamp: now,
        event_type: type
      });
    }

    document.addEventListener("mousemove", (e) => logMouseEvent(e, "move"));
    document.addEventListener("mousedown", (e) => logMouseEvent(e, "click"));
    document.addEventListener("mouseup",   (e) => logMouseEvent(e, "release"));

    // --- セグメンテーション処理 ---
    let currentWindowStart = performance.now();

    function segmentLogs() {
      const now = performance.now();

      if (now - currentWindowStart >= WINDOW_LENGTH_MS) {
        const windowEnd = currentWindowStart + WINDOW_LENGTH_MS;

        const windowData = mouseLogs.filter(
          log => log.timestamp >= currentWindowStart &&
                 log.timestamp < windowEnd
        );

        windows.push({
          window_id: `w_${Date.now()}`,
          start_time: currentWindowStart,
          end_time: windowEnd,
          window_length: WINDOW_LENGTH_MS,
          data: windowData
        });

        console.log("New window created:", windows[windows.length - 1]);

        // 次のウィンドウ開始
        currentWindowStart = windowEnd;
      }
    }

    // 100msごとにセグメンテーションチェック
    setInterval(segmentLogs, 100);
  </script>
</body>
</html>